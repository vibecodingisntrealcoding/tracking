<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturing Flow Tracker (Firestore)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icon Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Load Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f6; /* Modern, light background */
            color: #1f2937; /* Dark text */
            min-height: 100vh;
        }
        /* Style for the flow container: Fixed 3-column grid */
        #flow-container {
             display: grid;
             grid-template-columns: repeat(3, 1fr); /* 3 equal columns */
             gap: 1.5rem; /* Increased gap */
             padding: 0.5rem;
        }
        
        .stage-bubble {
            background-color: #ffffff; /* Clean white bubbles */
        }
        
        .unit-card {
            background-color: #ffffff; /* Clean white cards */
            border: 1px solid #e5e7eb; /* Subtle border */
        }

        /* Responsive grid adjustment for smaller screens */
        @media (max-width: 768px) {
            #flow-container {
                grid-template-columns: 1fr; /* Single column on mobile */
                gap: 1rem;
            }
            /* Force all columns to span 1 column on mobile */
            .stage-bubble {
                grid-column: span 1 !important; 
            }
        }
        
        /* Utility for sticky header within scrollable card */
        .stage-bubble .stage-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* Style for the warning header in dummy mode */
        .dummy-mode-header {
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-full mx-auto bg-white shadow-2xl rounded-3xl p-6 md:p-10">
        <header class="mb-8 border-b pb-4 border-gray-200">
            <h1 class="text-3xl font-extrabold text-gray-900">üè≠ Manufacturing Flow Tracker</h1>
            <p id="user-info" class="text-sm text-gray-500 font-bold mt-2">
                Initializing...
            </p>
        </header>

        <!-- Tab Controls and Job Management -->
        <div class="flex flex-wrap items-center justify-between mb-6 gap-3">
            <div id="job-tabs" class="flex flex-wrap border-b border-gray-200 flex-grow">
                <!-- Tabs will be rendered here -->
            </div>
            
            <button id="add-job-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-xl shadow-lg transition duration-150 transform hover:scale-[1.02]" onclick="showJobModal()">
                + Add New Job
            </button>
        </div>
        
        <!-- Search/Filter Bar -->
        <div id="search-bar-container" class="mb-8 pt-2 hidden">
            <div class="relative">
                <input 
                    type="text" 
                    id="unit-search-input" 
                    placeholder="Search by Unit ID or Notes..." 
                    class="w-full border border-gray-300 rounded-xl shadow-sm pl-10 pr-4 py-3 text-lg focus:ring-indigo-500 focus:border-indigo-500"
                    oninput="window.handleSearchInput(this.value)"
                >
                <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>

        <!-- Main Tracker Area (Fixed 3-Column Grid) -->
        <div id="tracker-content" class="w-full">
            <!-- Flow board or Summary table will be rendered here -->
            <div id="loading-indicator" class="text-center p-10 text-gray-500 text-lg font-medium">
                Connecting to database and authenticating user...
            </div>
        </div>

        <!-- Utility Panel (Add Units) -->
        <div id="utility-panel" class="mt-8 pt-6 border-t border-gray-200 hidden">
            <h2 class="text-xl font-bold mb-4 text-gray-700">Add Units to Current Job</h2>
            <div class="flex flex-wrap gap-4 items-end">
                <div class="flex-grow">
                    <label for="unit-name-prefix" class="block text-sm font-medium text-gray-700">Unit Name Prefix (e.g., ASIC-</label>
                    <input type="text" id="unit-name-prefix" value="UNIT-" placeholder="ASIC-" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="w-24">
                    <label for="unit-start-num" class="block text-sm font-medium text-gray-700">Start #</label>
                    <!-- min attribute will be set dynamically in JS -->
                    <input type="number" id="unit-start-num" value="101" min="1" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="w-24">
                    <label for="unit-end-num" class="block text-sm font-medium text-gray-700">End #</label>
                    <!-- min attribute will be set dynamically in JS -->
                    <input type="number" id="unit-end-num" value="105" min="1" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <!-- Button now calls the password protected function -->
                <button onclick="window.handleMassAddUnits()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-xl shadow-lg transition duration-150 h-10">
                    Mass Add Units
                </button>
            </div>
            <p id="unit-add-error" class="text-red-500 text-sm mt-2 hidden"></p>
        </div>
    </div>
    
    <!-- Modal for Adding New Job -->
    <div id="job-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-xl shadow-3xl w-full max-w-sm">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Create New Job/Project</h3>
            <label for="new-job-name" class="block text-sm font-medium text-gray-700 mb-2">Job Name</label>
            <input type="text" id="new-job-name" placeholder="Enter Job Name (e.g., F-2025-Q4)" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 mb-6 focus:ring-indigo-500 focus:border-indigo-500">
            <div class="flex justify-end space-x-3">
                <button onclick="hideJobModal()" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 font-medium">Cancel</button>
                <button onclick="addJob()" class="px-4 py-2 text-white bg-indigo-600 rounded-xl hover:bg-indigo-700 font-medium shadow-md">Create Job</button>
            </div>
        </div>
    </div>

    <!-- Modal for Job Deletion Confirmation -->
    <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-xl shadow-3xl w-full max-w-sm">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Confirm Deletion</h3>
            <p id="delete-modal-message" class="text-gray-700 mb-6">
                Are you sure you want to delete this job and all its tracking data? This action cannot be undone.
            </p>
            <div class="flex justify-end space-x-3">
                <button onclick="hideDeleteModal()" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 font-medium">Cancel</button>
                <!-- This button now calls the function that triggers the password modal -->
                <button id="confirm-delete-btn" onclick="" class="px-4 py-2 text-white bg-red-600 rounded-xl hover:bg-red-700 font-medium shadow-md">Delete Job</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Password Protection (NEW) -->
    <div id="password-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-xl shadow-3xl w-full max-w-sm">
            <h3 id="password-modal-title" class="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-2"><i class="fa-solid fa-lock text-red-500"></i> Access Required</h3>
            <p id="password-modal-message" class="text-gray-700 mb-4">
                Please enter the administrator password to perform this protected operation.
            </p>
            <input type="password" id="password-input" placeholder="Enter Admin Password" class="w-full border border-gray-300 rounded-lg shadow-sm p-3 mb-4 focus:ring-indigo-500 focus:border-indigo-500">
            <p id="password-error-message" class="text-red-500 text-sm mb-4 hidden">Incorrect password.</p>
            
            <div class="flex justify-end space-x-3">
                <button onclick="window.hidePasswordModal()" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 font-medium">Cancel</button>
                <button id="confirm-password-btn" onclick="window.handlePasswordSubmission()" class="px-4 py-2 text-white bg-indigo-600 rounded-xl hover:bg-indigo-700 font-medium shadow-md">Submit</button>
            </div>
        </div>
    </div>

    <!-- Modal for Unit Details and Notes -->
    <div id="unit-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl max-h-[90vh] overflow-y-auto">
            <div class="p-8">
                <h3 id="detail-unit-id" class="text-2xl font-bold text-indigo-700 mb-6"></h3>

                <!-- Notes Section -->
                <div class="mb-6">
                    <label for="unit-notes-textarea" class="block text-lg font-bold text-gray-700 mb-2">Notes & Comments</label>
                    <textarea 
                        id="unit-notes-textarea" 
                        rows="4" 
                        placeholder="Add critical information, rework details, or specific instructions here." 
                        class="w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 resize-none"
                    ></textarea>
                </div>

                <!-- History Section -->
                <div class="mb-6">
                    <h4 class="text-lg font-bold text-gray-700 mb-3 border-b pb-1 border-gray-200">Stage History</h4>
                    <div id="unit-history-log" class="space-y-3">
                        <!-- History items will be populated here -->
                    </div>
                </div>

                <!-- Footer Buttons -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button onclick="hideUnitDetailModal()" class="px-5 py-2 text-gray-700 bg-gray-200 rounded-xl hover:bg-gray-300 font-medium">Close</button>
                    <button onclick="saveUnitNotes()" class="px-5 py-2 text-white bg-green-600 rounded-xl hover:bg-green-700 font-medium transition duration-150 shadow-md">Save Notes</button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('debug'); // IMPORTANT: Debug log level is set
        
        // --- ADMIN CONFIGURATION ---
        const ADMIN_PASSWORD = "factoryadmin"; // Use this password to perform mass operations.
        
        // --- FIREBASE/GLOBAL STATE ---
        let db;
        let auth;
        let userId = null;
        let jobsRef = null;
        let isDummyMode = false; 
        
        // --- APPLICATION STATE ---
        let allJobs = []; // Synchronized from Firestore
        let activeJobId = null;
        let currentView = 'tracker'; 
        let detailUnitId = null; 
        let unitSearchQuery = ''; 
        let lastUnitInfo = { prefix: 'UNIT-', nextStartNum: 1 }; // State for unit auto-fill
        let pendingProtectedAction = null; // { type: 'mass-add' | 'delete' | 'delete-unit', data: jobId | unitId }


        // Fixed stages
        const STAGES = [
            "1. Engineering Release", "2. Parts Inventory", "3. Assembly", "4. Plumbing", "5. Electrical", 
            "6. Test", "7. Final Quality Check", "8. Finishing", "9. Ready To Ship", "10. Shipped"
        ];
        
        // Color mapping for stages
        const ACCENT_COLORS = [
            'blue', 'yellow', 'red', 'red', 'red', 
            'purple', 'purple', 'purple', 'green', 'green'
        ];
        
        // Icon mapping for stages
        const STAGE_ICONS = [
            'fa-solid fa-file-signature', 'fa-solid fa-boxes-stacked', 'fa-solid fa-wrench', 
            'fa-solid fa-water', 'fa-solid fa-bolt', 'fa-solid fa-vial-circle-check',
            'fa-solid fa-thumbs-up', 'fa-solid fa-paint-roller', 'fa-solid fa-shipping-fast',  
            'fa-solid fa-check-double'
        ];
        
        const FULL_WIDTH_STAGES = [0, 1, 8, 9]; 
        
        // --- UTILITIES ---

        const formatTime = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString(); 
        };

        const getCurrentJob = () => allJobs.find(j => j.id === activeJobId);
        
        // Logic to determine the next suggested Unit ID range
        const deriveLastUnitInfo = (job) => {
            if (!job || !job.units || job.units.length === 0) {
                // Requested change: If no units exist, start at 1
                lastUnitInfo = { prefix: 'UNIT-', nextStartNum: 1 }; 
                return;
            }

            let highestNum = 0;
            let bestUnitId = '';
            
            // 1. Find the unit ID with the highest numeric suffix
            job.units.forEach(unit => {
                // Regex to find all digits at the end of the string
                const match = unit.unitId.match(/(\d+)$/); 
                if (match) {
                    const currentNum = parseInt(match[1], 10);
                    if (currentNum > highestNum) {
                        highestNum = currentNum;
                        bestUnitId = unit.unitId;
                    }
                }
            });

            let mostLikelyPrefix = 'UNIT-';
            
            if (bestUnitId) {
                // 2. Extract the prefix (everything before the final digits)
                const matchPrefix = bestUnitId.match(/^(.*)(\d+)$/); 
                
                if (matchPrefix && matchPrefix.length > 1) {
                    // matchPrefix[1] is the prefix string (e.g., "ASIC-" from "ASIC-101")
                    mostLikelyPrefix = matchPrefix[1] || ''; 
                }
            }
            
            // 3. Set the global state
            lastUnitInfo = { 
                prefix: mostLikelyPrefix || 'UNIT-',
                nextStartNum: highestNum + 1 
            };
        };

        const updateUnitInputs = () => {
            if (!activeJobId) return;

            const activeJob = getCurrentJob();
            deriveLastUnitInfo(activeJob); // Calculate based on current job data
            
            const prefixInput = document.getElementById('unit-name-prefix');
            const startNumInput = document.getElementById('unit-start-num');
            const endNumInput = document.getElementById('unit-end-num');
            
            const requiredMinStart = lastUnitInfo.nextStartNum;
            
            if (prefixInput) prefixInput.value = lastUnitInfo.prefix;
            
            if (startNumInput) {
                // MANDATORY: Set the minimum allowed value to prevent going backwards
                startNumInput.min = requiredMinStart;
                
                // If the field is currently empty or contains a number lower than the required minimum, reset its value.
                const currentStartValue = parseInt(startNumInput.value) || 0;
                if (currentStartValue < requiredMinStart || (currentStartValue === 0 && requiredMinStart === 1)) {
                    startNumInput.value = requiredMinStart;
                }
            }
            
            if (endNumInput) {
                // The minimum for the end field is technically the start field's current value, 
                // but we check against the required minimum for consistency.
                const currentEndValue = parseInt(endNumInput.value) || 0;
                
                // If the end value is too low, or if we are switching to a job with higher IDs, reset the suggestion.
                if (currentEndValue < requiredMinStart) {
                    endNumInput.value = requiredMinStart + 4;
                }
            }
        };


        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        // User-provided configuration for fallback/guaranteeing connection
        const USER_PROVIDED_CONFIG = {
            apiKey: "AIzaSyCOqFYm7K0tXATVPnFlFe4qbR4MzLDs3zk",
            authDomain: "akron-manufacturing-tracker.firebaseapp.com",
            projectId: "akron-manufacturing-tracker",
            storageBucket: "akron-manufacturing-tracker.firebasestorage.app",
            messagingSenderId: "486505051181",
            appId: "1:486505051181:web:00ca9a11dffefb3b8974a4"
        };


        const initFirebase = async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
                let firebaseConfig = null;

                // 1. Try to use the environment's global config
                if (firebaseConfigString && firebaseConfigString.trim() !== '' && firebaseConfigString !== '{}') {
                    try {
                         firebaseConfig = JSON.parse(firebaseConfigString);
                    } catch (e) {
                         console.error("Platform config is malformed JSON. Using hardcoded configuration.");
                    }
                }
                
                // 2. Fallback to the user-provided configuration if the global one was missing or malformed
                const isPlatformConfigValid = firebaseConfig && firebaseConfig.projectId && !firebaseConfig.projectId.includes("dummy");

                if (!isPlatformConfigValid) {
                    console.warn("Platform configuration missing or invalid. Using hardcoded USER_PROVIDED_CONFIG.");
                    firebaseConfig = USER_PROVIDED_CONFIG;
                }
                
                // 3. Final check for DUMMY MODE: Check the final config for validity
                const isFinalConfigValid = firebaseConfig && firebaseConfig.projectId && !firebaseConfig.projectId.includes("dummy");
                
                if (!isFinalConfigValid) {
                    isDummyMode = true;

                    // Setup dummy configuration (non-functional, just for initialization)
                    firebaseConfig = {
                        apiKey: "DUMMY_API_KEY",
                        authDomain: "dummy-project.firebaseapp.com",
                        projectId: "dummy-project-12345",
                        storageBucket: "dummy-project.appspot.com",
                        messagingSenderId: "1234567890",
                        appId: "1:1234567890:web:dummy",
                    };
                    
                    // Set up initial dummy state for UI
                    allJobs = [{ 
                        id: 'dummy-job', 
                        jobName: 'DUMMY JOB (No Persistence)', 
                        units: [
                            { unitId: 'DEMO-001', stage: 2, notes: 'Cannot save data or collaborate. This unit moves automatically.', history: [] },
                            { unitId: 'DEMO-002', stage: 0, notes: '', history: [] },
                            { unitId: 'DEMO-010', stage: 8, notes: 'Ready to ship for demo.', history: [] },
                            { unitId: 'DEMO-011', stage: 8, notes: 'Another ready unit.', history: [] },
                        ],
                        createdAt: Date.now(),
                        createdBy: 'system'
                    }];
                    activeJobId = 'dummy-job';
                    userId = 'DUMMY_USER';

                    // Update UI with clear warning
                    const userInfoElement = document.getElementById('user-info');
                    userInfoElement.innerHTML = `
                        <i class="fa-solid fa-triangle-exclamation text-red-500 mr-2 dummy-mode-header"></i>
                        <span class="text-red-600 font-extrabold">DUMMY MODE: Config Missing. Data Will NOT Persist.</span>
                    `;
                    
                    // Hide loading and show UI
                    document.getElementById('loading-indicator').classList.add('hidden');
                    renderUI();
                    
                    // Add automatic movement for demo purposes
                    setInterval(dummyMoveUnit, 4000); 
                    return; // Stop Firebase initialization
                }
                // --- END DUMMY MODE FALLBACK ---


                // --- REAL FIREBASE INITIALIZATION ---
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                jobsRef = collection(db, 'artifacts', appId, 'public', 'data', 'jobs');

                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (tokenError) {
                        console.warn("Custom Token Sign-In Failed. Falling back to Anonymous Sign-In.", tokenError);
                        await signInAnonymously(auth); 
                    }
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-info').textContent = 
                            `Connected as: ${userId} (Real-time collaboration enabled)`;
                        setupFirestoreListener();
                    } else {
                        document.getElementById('user-info').textContent = 
                            'Connection Error: Not authenticated.';
                        document.getElementById('loading-indicator').textContent = 
                            'Authentication failed. Cannot load data.';
                    }
                });

            } catch (error) {
                // Catch any errors during initialization (e.g., config problems)
                console.error("Firebase Initialization Error:", error);
                document.getElementById('user-info').textContent = 'Error during Firebase setup. Check console.';
                
                document.getElementById('loading-indicator').innerHTML = `
                    <div class="text-red-600 font-bold text-2xl">FATAL CONNECTION ERROR</div>
                    <p class="text-base mt-3 text-gray-700">The application cannot connect to the database. Check console for configuration issues.</p>
                    <p class="text-sm italic mt-2 p-3 bg-red-50 rounded-lg border border-red-300">
                        Details: ${error.message}
                    </p>
                `;
            }
        };

        // --- DUMMY MODE LOGIC ---
        const dummyMoveUnit = () => {
             if (!isDummyMode) return;
             
             const job = allJobs.find(j => j.id === activeJobId);
             if (!job || job.units.length === 0) return;

             const unitIndex = job.units.findIndex(u => u.unitId === 'DEMO-001');
             if (unitIndex === -1) return;

             let unit = job.units[unitIndex];
             let newStage = (unit.stage + 1) % STAGES.length;
             
             if (newStage === 0) {
                 // Reset after final stage
                 unit.stage = 0;
             } else {
                 unit.stage = newStage;
             }
             
             unit.history.push({ 
                 action: 'move',
                 stageIndex: unit.stage,
                 timestamp: Date.now(),
                 movedBy: 'DUMMY_SYSTEM'
             });

             // Force UI refresh in dummy mode
             renderUI();
        };


        // --- FIREBASE DATA SYNCHRONIZATION ---

        const setupFirestoreListener = () => {
            if (isDummyMode) return;
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.textContent = 'Syncing data...';

            const q = query(jobsRef);

            onSnapshot(q, (snapshot) => {
                const updatedJobs = [];
                snapshot.forEach((doc) => {
                    updatedJobs.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                allJobs = updatedJobs.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));

                const activeJobExists = allJobs.some(job => job.id === activeJobId);
                if (!activeJobExists && allJobs.length > 0) {
                    activeJobId = allJobs[0].id; 
                    currentView = 'tracker';
                } else if (allJobs.length === 0) {
                    activeJobId = null;
                    currentView = 'summary'; 
                }

                renderUI();
                loadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("Firestore Listener Error:", error);
                document.getElementById('tracker-content').innerHTML = 
                    '<div class="text-center p-10 text-red-600 text-lg font-medium">Error loading real-time data. Check console for details.</div>';
            });
        };
        
        // --- View Switching Logic (No change, uses synced 'allJobs') ---

        const switchJob = (jobId) => {
            activeJobId = jobId;
            currentView = 'tracker'; 
            renderUI();
        };

        const switchViewToSummary = () => {
            currentView = 'summary';
            renderUI();
        };

        // --- Search/Filter Logic (No change) ---

        const handleSearchInput = (query) => {
            unitSearchQuery = query;
            renderTracker(); 
        };
        
        // --- UI Rendering (Call updateUnitInputs here) ---

        const renderUI = () => {
            renderTabs();
            
            const searchContainer = document.getElementById('search-bar-container');
            searchContainer.classList.toggle('hidden', currentView === 'summary' || !activeJobId);
            
            if (currentView === 'summary') {
                renderSummary();
            } else {
                renderTracker();
            }
            
            const panel = document.getElementById('utility-panel');
            if (panel) {
                panel.classList.toggle('hidden', !activeJobId || currentView === 'summary');
            }
            
            // Auto-populate unit addition fields on UI refresh/job switch
            if (activeJobId && currentView !== 'summary') {
                updateUnitInputs();
            }
        };

        const renderTabs = () => {
            const tabsContainer = document.getElementById('job-tabs');
            tabsContainer.innerHTML = '';

            // 1. Render Overall Summary Tab
            const summaryActive = currentView === 'summary';
            const summaryClasses = summaryActive ? 'border-indigo-600 text-indigo-600 bg-indigo-50/50 font-bold' : 'border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-300';
            
            tabsContainer.insertAdjacentHTML('beforeend', `
                <button 
                    class="px-4 py-3 text-sm font-medium border-b-2 ${summaryClasses} transition duration-150 rounded-t-lg mr-4"
                    onclick="window.switchViewToSummary()"
                >
                    <i class="fa-solid fa-chart-line mr-1"></i> Overall Summary
                </button>
            `);

            // 2. Render Job Tabs
            if (allJobs.length === 0 && currentView !== 'summary') {
                tabsContainer.insertAdjacentHTML('beforeend', `<p class="text-gray-500 italic p-2">No jobs created yet. Click '+ Add New Job' to start.</p>`);
                return;
            }

            allJobs.forEach(job => {
                const isActive = job.id === activeJobId && currentView === 'tracker';
                const activeClasses = isActive ? 'border-indigo-600 text-indigo-600 bg-indigo-50/50 font-bold' : 'border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-300';
                
                const deleteButton = isDummyMode ? '' : `
                    <button 
                        class="ml-2 text-red-400 hover:text-red-600 text-xs"
                        onclick="event.stopPropagation(); window.showDeleteModal('${job.id}', '${job.jobName}')"
                    >
                        (x)
                    </button>
                `;

                const tabHtml = `
                    <button 
                        class="px-4 py-3 text-sm font-medium border-b-2 ${activeClasses} transition duration-150 rounded-t-lg relative"
                        onclick="window.switchJob('${job.id}')"
                    >
                        ${job.jobName}
                        ${isActive ? deleteButton : ''}
                    </button>
                `;
                tabsContainer.insertAdjacentHTML('beforeend', tabHtml);
            });
        };

        const renderTracker = () => {
            const trackerContainer = document.getElementById('tracker-content');

            if (currentView === 'summary' || !activeJobId) {
                trackerContainer.innerHTML = ''; 
                return; 
            }

            const activeJob = getCurrentJob();
            if (!activeJob) {
                trackerContainer.innerHTML = '<div class="text-center p-10 text-gray-500">Job not found. Select or create a job.</div>';
                return;
            }

            const units = activeJob.units || [];
            const query = unitSearchQuery.toLowerCase(); 

            let flowHTML = `<div id="flow-container" class="grid grid-cols-3 gap-6">`;
            let totalFilteredUnits = 0;

            STAGES.forEach((stageName, stageIndex) => {
                let unitsInStage = units.filter(u => u.stage === stageIndex);
                
                if (query) {
                    unitsInStage = unitsInStage.filter(unit => 
                        unit.unitId.toLowerCase().includes(query) || 
                        (unit.notes && unit.notes.toLowerCase().includes(query))
                    );
                }
                
                totalFilteredUnits += unitsInStage.length;

                const isFinalStage = stageIndex === STAGES.length - 1;
                const isFirstStage = stageIndex === 0; // Check for first stage
                const isFullWidth = FULL_WIDTH_STAGES.includes(stageIndex);
                const color = ACCENT_COLORS[stageIndex];
                const iconClass = STAGE_ICONS[stageIndex];
                const cleanStageName = stageName.split('. ')[1]; 
                const layoutClasses = isFullWidth ? 'lg:col-span-3' : 'lg:col-span-1';
                const headerBgColor = `bg-${color}-600`; 
                const headerTextColor = `text-white`;
                const headerCountColor = `text-${color}-200`; 
                const innerContainerClasses = isFullWidth
                    ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3'
                    : 'flex flex-col gap-3'; 


                // Stage Bubble/Column Container
                flowHTML += `
                    <div class="rounded-xl shadow-lg flex flex-col min-h-[400px] stage-bubble ${layoutClasses} col-span-1 md:col-span-3">
                        <!-- Full color header with icon -->
                        <h3 class="text-xl font-extrabold ${headerTextColor} ${headerBgColor} p-4 flex items-center justify-center gap-3 rounded-t-xl sticky top-0 stage-header">
                            <i class="${iconClass}"></i>
                            <span>${cleanStageName}</span>
                            <span class="${headerCountColor} font-medium ml-1 text-sm">(${unitsInStage.length})</span>
                        </h3>
                        
                        <!-- Container for Unit Cards -->
                        <div class="${innerContainerClasses} flex-grow overflow-y-auto p-4">
                `;

                // Unit Cards inside the bubble
                if (unitsInStage.length === 0) {
                     flowHTML += `<p class="text-center text-gray-400 italic py-4">
                        ${query ? 'No matching units found.' : 'No units in this stage.'}
                    </p>`;
                } else {
                    unitsInStage.forEach(unit => {
                        const unitNotesIndicator = unit.notes && unit.notes.length > 0 ? 
                            '<span class="text-indigo-500 text-xs font-semibold ml-1">üìù</span>' : '';
                        
                        // NEW: Back Action
                        const backButton = !isFirstStage ? `
                            <button 
                                onclick="event.stopPropagation(); window.updateUnitStageBackward('${unit.unitId}', ${stageIndex - 1})"
                                class="${isDummyMode ? 'text-gray-400 cursor-not-allowed' : 'text-gray-500 hover:text-indigo-700 hover:bg-gray-100'} p-1 rounded-full transition duration-150 flex-shrink-0"
                                title="${isDummyMode ? 'Saving is disabled in Dummy Mode' : `Move back to ${STAGES[stageIndex - 1].split('. ')[1]}`}"
                                ${isDummyMode ? 'disabled' : ''}
                            >
                                <!-- Simple SVG Left Arrow icon for movement -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        ` : '';
                        
                        // NEW: Delete Action (Password Protected)
                        const deleteButton = `
                            <button 
                                onclick="event.stopPropagation(); window.startProtectedDeleteUnit('${unit.unitId}')"
                                class="${isDummyMode ? 'text-gray-400 cursor-not-allowed' : 'text-red-500 hover:text-red-700 hover:bg-red-50'} p-1 rounded-full transition duration-150 flex-shrink-0"
                                title="${isDummyMode ? 'Saving is disabled in Dummy Mode' : `Permanently delete unit ${unit.unitId}`}"
                                ${isDummyMode ? 'disabled' : ''}
                            >
                                <i class="fa-solid fa-trash-can text-sm"></i>
                            </button>
                        `;

                        // Compact Advance Action
                        const advanceButton = !isFinalStage ? `
                            <button 
                                onclick="event.stopPropagation(); window.updateUnitStage('${unit.unitId}', ${stageIndex + 1})"
                                class="${isDummyMode ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'text-indigo-500 hover:text-indigo-700 hover:bg-indigo-50'} p-1 rounded-full transition duration-150 flex-shrink-0"
                                title="${isDummyMode ? 'Saving is disabled in Dummy Mode' : `Move to ${STAGES[stageIndex + 1].split('. ')[1]}`}"
                                ${isDummyMode ? 'disabled' : ''}
                            >
                                <!-- Simple SVG Right Arrow icon for movement -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        ` : `
                            <span class="text-green-500 text-sm font-semibold flex-shrink-0">‚úÖ Final</span>
                        `;
                        
                        // Combine actions: Back button, Delete button, Forward button
                        const unitActions = `
                            <div class="flex items-center space-x-1">
                                ${backButton}
                                ${deleteButton}
                                ${advanceButton}
                            </div>
                        `;

                        // Card structure is now a single flex row
                        flowHTML += `
                            <div class="unit-card p-3 rounded-xl shadow-md transition-all duration-300 hover:shadow-lg hover:ring-2 hover:ring-offset-2 hover:ring-indigo-400 cursor-pointer"
                                onclick="window.showUnitDetailModal('${unit.unitId}')"
                                title="View details and history for ${unit.unitId}"
                            >
                                <div class="flex justify-between items-center">
                                    <!-- Unit ID is clickable to open details -->
                                    <div class="text-base font-semibold text-gray-800 flex-grow truncate">
                                        ${unit.unitId} ${unitNotesIndicator}
                                    </div>
                                    ${unitActions}
                                </div>
                            </div>
                        `;
                    });
                }

                // Close Stage Bubble/Column Container
                flowHTML += `
                        </div>
                    </div>
                `;
            });
            
            flowHTML += `</div>`;
            trackerContainer.innerHTML = flowHTML;

            const searchInput = document.getElementById('unit-search-input');
            if(searchInput) {
                searchInput.value = unitSearchQuery;
            }

            if (query && totalFilteredUnits === 0) {
                 trackerContainer.insertAdjacentHTML('beforeend', `<div class="text-center p-10 text-gray-500 text-xl font-medium">
                    No units matched the search query: "${query}" in this job.
                </div>`);
            }
        };

        const renderSummary = () => {
            const trackerContainer = document.getElementById('tracker-content');
            trackerContainer.innerHTML = '';
            
            const summaryData = calculateSummaryData(allJobs);

            if (summaryData.length === 0) {
                trackerContainer.innerHTML = '<div class="text-center p-10 text-gray-500">No jobs available to generate an overall summary.</div>';
                return;
            }

            const headerRow = STAGES.map(stage => {
                const cleanName = stage.split('. ')[1];
                return `<th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">${cleanName}</th>`;
            }).join('');

            let tableRows = '';
            summaryData.forEach((jobSummary, jobIndex) => {
                const rowClasses = jobIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                let stageCells = '';
                const maxUnitAcrossStages = Math.max(...jobSummary.stageMaxes);

                jobSummary.stageMaxes.forEach((maxNum, stageIndex) => {
                    const isHighlight = maxNum > 0 && maxNum === maxUnitAcrossStages && stageIndex === jobSummary.stageMaxes.lastIndexOf(maxUnitAcrossStages);
                    
                    const cellClasses = isHighlight 
                        ? 'bg-indigo-100 text-indigo-800 font-bold border-l-4 border-indigo-500' 
                        : 'text-gray-800';

                    stageCells += `<td class="px-4 py-4 whitespace-nowrap text-sm ${cellClasses}">
                        ${maxNum > 0 ? maxNum : '-'}
                    </td>`;
                });

                tableRows += `
                    <tr class="${rowClasses} hover:bg-gray-100 transition duration-150">
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white shadow-inner rounded-l-lg">
                            ${jobSummary.jobName}
                        </td>
                        ${stageCells}
                    </tr>
                `;
            });

            // --- NEW LOGIC FOR READY TO SHIP UNITS ---
            const READY_TO_SHIP_STAGE_INDEX = 8;
            const READY_TO_SHIP_STAGE_NAME = STAGES[READY_TO_SHIP_STAGE_INDEX].split('. ')[1];

            let readyToShipUnits = [];

            // Iterate and collect all units in the 'Ready To Ship' stage across all jobs
            allJobs.forEach(job => {
                (job.units || []).forEach(unit => {
                    if (unit.stage === READY_TO_SHIP_STAGE_INDEX) {
                        readyToShipUnits.push({
                            unitId: unit.unitId,
                            jobName: job.jobName,
                            notes: unit.notes // Include notes for context
                        });
                    }
                });
            });

            // Generate HTML for the units list
            let unitsListHtml = '';
            if (readyToShipUnits.length === 0) {
                unitsListHtml = '<p class="text-center text-gray-500 italic p-6">No units are currently in the "Ready To Ship" stage across all jobs.</p>';
            } else {
                // Render as a responsive grid of cards for better readability
                unitsListHtml = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mt-4">
                `;
                
                readyToShipUnits.forEach(unit => {
                    // Truncate notes for the card view
                    const notesIndicator = unit.notes ? 
                        `<p class="text-xs text-gray-500 mt-1 truncate" title="${unit.notes}">Notes: ${unit.notes}</p>` :
                        `<p class="text-xs text-gray-400 mt-1 italic">No notes.</p>`;

                    unitsListHtml += `
                        <div class="p-4 bg-white border border-green-300 rounded-xl shadow-md transition duration-150 hover:shadow-lg">
                            <p class="text-lg font-bold text-green-700">${unit.unitId}</p>
                            <p class="text-sm text-gray-600 font-medium border-b pb-1 mb-1">Job: ${unit.jobName}</p>
                            ${notesIndicator}
                        </div>
                    `;
                });
                
                unitsListHtml += `</div>`;
            }

            // Combine all summary parts
            trackerContainer.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-3"><i class="fa-solid fa-chart-line text-indigo-600"></i> Overall Progress Summary</h2>
                <div class="overflow-x-auto shadow-xl rounded-2xl border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100 sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider sticky left-0 bg-gray-100 rounded-tl-2xl">Job/Project Name</th>
                                ${headerRow}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
                <p class="mt-4 text-sm text-gray-500 p-2">
                    Note: This table tracks the **highest unit number** (the numeric suffix of the Unit ID) that has entered each stage for every job. 
                    The highlighted cells indicate the most advanced stage reached by the highest numbered unit for that specific job.
                </p>

                <!-- NEW READY TO SHIP SECTION -->
                <div class="mt-12 pt-6 border-t border-gray-200">
                    <h3 class="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                        <i class="fa-solid fa-truck-fast text-green-600"></i> ${READY_TO_SHIP_STAGE_NAME} Inventory (${readyToShipUnits.length})
                    </h3>
                    ${unitsListHtml}
                </div>
                
            `;
        };

        const calculateSummaryData = (jobs) => {
            return jobs.map(job => {
                const stageMaxes = new Array(STAGES.length).fill(0); 

                job.units.forEach(unit => {
                    const stageIndex = unit.stage;
                    const unitId = unit.unitId;
                    
                    const match = unitId.match(/(\d+)$/); 
                    if (match) {
                        const unitNum = parseInt(match[1], 10);
                        
                        if (unitNum > stageMaxes[stageIndex]) {
                            stageMaxes[stageIndex] = unitNum;
                        }
                    }
                });

                return {
                    jobName: job.jobName,
                    id: job.id,
                    stageMaxes: stageMaxes
                };
            });
        };

        // --- Job Modal/UI Helpers ---

        const showJobModal = () => {
            if (isDummyMode) {
                // Use the unit detail modal as a message box
                showUnitDetailModal('ALERT');
                document.getElementById('detail-unit-id').textContent = 'Action Disabled in Dummy Mode';
                document.getElementById('unit-notes-textarea').value = 'You are currently running without a Firebase connection. Please enable the connection to create and manage real jobs.';
                document.getElementById('unit-history-log').innerHTML = '';
                document.querySelector('#unit-detail-modal button[onclick="saveUnitNotes()"]').classList.add('hidden');
                return;
            }
            document.getElementById('job-modal').classList.remove('hidden');
        };

        const hideJobModal = () => {
            document.getElementById('job-modal').classList.add('hidden');
        };

        const showDeleteModal = (jobId, jobName) => {
             if (isDummyMode) return;
            document.getElementById('delete-modal-message').innerHTML = 
                `Are you sure you want to delete the job <strong>'${jobName}'</strong> and all its tracking data? This action cannot be undone. This will affect all collaborators.`;
            
            const confirmBtn = document.getElementById('confirm-delete-btn');
            // This button now triggers the password flow, not the direct deletion
            confirmBtn.onclick = () => startProtectedDelete(jobId, jobName); 

            document.getElementById('delete-modal').classList.remove('hidden');
        };
        
        const hideDeleteModal = () => {
            document.getElementById('delete-modal').classList.add('hidden');
        };
        
        // --- FIREBASE: DELETE JOB ---
        const deleteJob = async (jobId) => {
            if (isDummyMode || !jobsRef || !userId) return console.error("Action disabled in Dummy Mode.");
            
            try {
                await deleteDoc(doc(jobsRef, jobId));
            } catch (error) {
                    console.error("Error deleting job:", error);
            }
        }

        // --- Unit Detail Modal Functions ---

        let currentUnitData = null;

        const showUnitDetailModal = (unitId) => {
            if (!activeJobId) return;

            const activeJob = getCurrentJob();
            const unit = activeJob.units.find(u => u.unitId === unitId);

            if (!unit) return;
            
            currentUnitData = unit;
            document.getElementById('detail-unit-id').textContent = `Unit Details: ${unitId}`;
            document.getElementById('unit-notes-textarea').value = unit.notes || '';
            
            // Show/Hide save button based on mode
            const saveBtn = document.querySelector('#unit-detail-modal button[onclick="saveUnitNotes()"]');
            saveBtn.classList.toggle('hidden', isDummyMode);
            
            const historyLog = document.getElementById('unit-history-log');
            historyLog.innerHTML = '';

            if (unit.history && unit.history.length > 0) {
                unit.history.slice().reverse().forEach(entry => {
                    const stageName = STAGES[entry.stageIndex] || 'Unknown Stage';
                    const timestamp = formatTime(entry.timestamp); 
                    const movedBy = entry.movedBy || 'System/Initial Add';
                    const action = entry.action === 'note' ? 'Note Saved' : 'Moved to';

                    const historyItem = `
                        <div class="p-3 bg-gray-100 rounded-lg border border-gray-200 text-sm">
                            <p class="font-medium text-gray-800">
                                ${action}: <span class="text-indigo-600 font-bold">${stageName}</span>
                            </p>
                            <p class="text-gray-500 mt-1">
                                at ${timestamp} by <span class="truncate">${movedBy}</span>
                            </p>
                        </div>
                    `;
                    historyLog.insertAdjacentHTML('beforeend', historyItem);
                });
            } else {
                 historyLog.innerHTML = '<p class="text-gray-500 italic p-2">No stage history recorded yet.</p>';
            }

            document.getElementById('unit-detail-modal').classList.remove('hidden');
        };

        const hideUnitDetailModal = () => {
            document.getElementById('unit-detail-modal').classList.add('hidden');
            currentUnitData = null;
            // Restore save button visibility
            document.querySelector('#unit-detail-modal button[onclick="saveUnitNotes()"]').classList.remove('hidden');
        };

        // --- FIREBASE: SAVE UNIT NOTES ---
        const saveUnitNotes = async () => {
            if (isDummyMode || !activeJobId || !currentUnitData || !userId) return console.error("Action disabled in Dummy Mode.");

            const newNotes = document.getElementById('unit-notes-textarea').value.trim();
            const unitIdToUpdate = currentUnitData.unitId;

            if (newNotes === currentUnitData.notes) {
                hideUnitDetailModal();
                return;
            }

            const newHistoryEntry = {
                action: 'note',
                stageIndex: currentUnitData.stage, 
                timestamp: Date.now(),
                movedBy: userId 
            };

            // REAL FIREBASE UPDATE
            try {
                const jobDocRef = doc(jobsRef, activeJobId);
                const jobDoc = await getDoc(jobDocRef);
                
                if (jobDoc.exists()) {
                    const jobData = jobDoc.data();
                    const units = jobData.units || [];
                    const unitIndex = units.findIndex(u => u.unitId === unitIdToUpdate);
                    
                    if (unitIndex !== -1) {
                        units[unitIndex] = {
                            ...units[unitIndex],
                            notes: newNotes,
                            history: [...(units[unitIndex].history || []), newHistoryEntry]
                        };
                        await updateDoc(jobDocRef, { units: units });
                        hideUnitDetailModal();
                    }
                }
            } catch (error) {
                console.error("Error saving unit notes:", error);
            }
        };

        // --- FIREBASE: ADD NEW JOB ---
        const addJob = async () => {
            if (isDummyMode || !jobsRef || !userId) return console.error("Action disabled in Dummy Mode.");

            const jobNameInput = document.getElementById('new-job-name');
            const jobName = jobNameInput.value.trim();

            if (!jobName) return console.warn('Job name cannot be empty.'); 

            hideJobModal();
            
            const newJobData = {
                jobName: jobName,
                units: [],
                createdAt: Date.now(),
                createdBy: userId
            };

            try {
                const docRef = await addDoc(jobsRef, newJobData);
                activeJobId = docRef.id; 
                currentView = 'tracker';
                jobNameInput.value = '';
            } catch (error) {
                console.error("Error adding new job:", error);
            }
        };

        // --- FIREBASE: UPDATE UNIT STAGE FORWARD ---
        const updateUnitStage = async (unitId, newStageIndex) => {
            if (isDummyMode || !activeJobId || !userId) return console.error("Action disabled in Dummy Mode.");
            
            const newHistoryEntry = {
                action: 'move',
                stageIndex: newStageIndex,
                timestamp: Date.now(),
                movedBy: userId
            };

            // REAL FIREBASE UPDATE
            if (!jobsRef) return;
            try {
                const jobDocRef = doc(jobsRef, activeJobId);
                const jobDoc = await getDoc(jobDocRef);
                
                if (jobDoc.exists()) {
                    const jobData = jobDoc.data();
                    const units = jobData.units || [];
                    
                    const unitIndex = units.findIndex(u => u.unitId === unitId);
                    
                    if (unitIndex !== -1) {
                        units[unitIndex] = {
                            ...units[unitIndex],
                            stage: newStageIndex,
                            history: [...(units[unitIndex].history || []), newHistoryEntry],
                            notes: units[unitIndex].notes || ""
                        };

                        await updateDoc(jobDocRef, { units: units });
                    }
                }
            } catch (error) {
                console.error("Error updating unit stage:", error);
            }
        };

        // --- FIREBASE: UPDATE UNIT STAGE BACKWARD (NEW FUNCTION) ---
        const updateUnitStageBackward = async (unitId, newStageIndex) => {
            if (isDummyMode || !activeJobId || !userId || newStageIndex < 0) return console.error("Action disabled or invalid stage index.");
            
            const newHistoryEntry = {
                action: 'move',
                stageIndex: newStageIndex,
                timestamp: Date.now(),
                movedBy: userId
            };

            // REAL FIREBASE UPDATE
            if (!jobsRef) return;
            try {
                const jobDocRef = doc(jobsRef, activeJobId);
                const jobDoc = await getDoc(jobDocRef);
                
                if (jobDoc.exists()) {
                    const jobData = jobDoc.data();
                    const units = jobData.units || [];
                    
                    const unitIndex = units.findIndex(u => u.unitId === unitId);
                    
                    if (unitIndex !== -1) {
                        units[unitIndex] = {
                            ...units[unitIndex],
                            stage: newStageIndex,
                            history: [...(units[unitIndex].history || []), newHistoryEntry],
                            notes: units[unitIndex].notes || ""
                        };

                        await updateDoc(jobDocRef, { units: units });
                    }
                }
            } catch (error) {
                console.error("Error updating unit stage backward:", error);
            }
        };
        
        // --- PASSWORD PROTECTION LOGIC ---
        
        const showPasswordModal = () => {
            const modal = document.getElementById('password-modal');
            const input = document.getElementById('password-input');
            const errorMsg = document.getElementById('password-error-message');

            errorMsg.classList.add('hidden');
            input.value = '';
            input.focus();
            
            modal.classList.remove('hidden');
        };

        const hidePasswordModal = () => {
            document.getElementById('password-modal').classList.add('hidden');
            pendingProtectedAction = null; // Clear state on cancel/close
        };

        // Function called by the confirmation modal's 'Delete' button (for Job)
        const startProtectedDelete = (jobId, jobName) => {
            hideDeleteModal(); // Hide the initial confirmation modal
            if (isDummyMode) return;
            
            pendingProtectedAction = { type: 'delete', data: jobId, jobName: jobName };
            
            // Update password modal for the specific action
            document.getElementById('password-modal-title').innerHTML = `<i class="fa-solid fa-eraser text-red-500"></i> Confirm Job Deletion`;
            document.getElementById('password-modal-message').innerHTML = `Please enter the administrator password to **permanently delete** job <strong>'${jobName}'</strong>.`;
            document.getElementById('confirm-password-btn').textContent = 'Confirm Deletion';
            document.getElementById('confirm-password-btn').classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            document.getElementById('confirm-password-btn').classList.add('bg-red-600', 'hover:bg-red-700');
            
            showPasswordModal();
        };

        // Function called by the card's delete button to start the password flow (for Unit)
        const startProtectedDeleteUnit = (unitId) => {
            if (isDummyMode) return;
            
            pendingProtectedAction = { type: 'delete-unit', data: unitId };
            
            // Update password modal for the specific action
            document.getElementById('password-modal-title').innerHTML = `<i class="fa-solid fa-trash-can text-red-500"></i> Delete Unit Confirmation`;
            document.getElementById('password-modal-message').innerHTML = `Please enter the administrator password to **permanently delete** unit <strong>'${unitId}'</strong> from this job.`;
            document.getElementById('confirm-password-btn').textContent = 'Confirm Delete';
            document.getElementById('confirm-password-btn').classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            document.getElementById('confirm-password-btn').classList.add('bg-red-600', 'hover:bg-red-700');
            
            showPasswordModal();
        };

        // Public button handler for Mass Add Units
        const handleMassAddUnits = () => {
            if (isDummyMode) {
                const errorElement = document.getElementById('unit-add-error');
                errorElement.textContent = "Action disabled in Dummy Mode: Cannot save data.";
                errorElement.classList.remove('hidden');
                return;
            }
            
            pendingProtectedAction = { type: 'mass-add', data: null };
            
            // Update password modal for the specific action
            document.getElementById('password-modal-title').innerHTML = `<i class="fa-solid fa-lock text-red-500"></i> Access Required`;
            document.getElementById('password-modal-message').innerHTML = 'Please enter the administrator password to **add a batch** of units.';
            document.getElementById('confirm-password-btn').textContent = 'Submit';
            document.getElementById('confirm-password-btn').classList.remove('bg-red-600', 'hover:bg-red-700');
            document.getElementById('confirm-password-btn').classList.add('bg-indigo-600', 'hover:bg-indigo-700');

            showPasswordModal();
        }

        const handlePasswordSubmission = () => {
            const passwordInput = document.getElementById('password-input');
            const password = passwordInput.value.trim();
            const errorMsg = document.getElementById('password-error-message');

            errorMsg.classList.add('hidden');

            if (password === ADMIN_PASSWORD) {
                // FIX: Capture the action and clear the global state BEFORE hiding the modal.
                const action = pendingProtectedAction; 
                pendingProtectedAction = null; // Clear global state now
                
                document.getElementById('password-modal').classList.add('hidden'); 
                
                if (action && action.type === 'mass-add') {
                    handleMassAddUnitsCore(); // Execute mass add
                } else if (action && action.type === 'delete' && action.data) {
                    deleteJob(action.data); // Execute job deletion
                } else if (action && action.type === 'delete-unit' && action.data) { // NEW CASE: Delete Unit
                    deleteUnitCore(action.data); // Execute unit deletion
                } else {
                     console.error("No valid pending protected action found. This is likely due to a race condition or state corruption.");
                }
                
            } else {
                errorMsg.textContent = "Incorrect password. Access denied.";
                errorMsg.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        };
        
        // --- FIREBASE: MASS ADD UNITS CORE (Protected Logic) ---
        const handleMassAddUnitsCore = async () => {
            if (!activeJobId || !jobsRef || !userId) {
                console.error("Cannot proceed without active job or user ID.");
                return;
            }

            const prefix = document.getElementById('unit-name-prefix').value.trim();
            const startNum = parseInt(document.getElementById('unit-start-num').value);
            const endNum = parseInt(document.getElementById('unit-end-num').value);
            const errorElement = document.getElementById('unit-add-error');
            
            errorElement.classList.add('hidden');

            if (!prefix || isNaN(startNum) || isNaN(endNum) || startNum > endNum || startNum < 1) {
                errorElement.textContent = "Please enter a prefix and valid start/end numbers (Start ‚â§ End, both > 0).";
                errorElement.classList.remove('hidden');
                return;
            }
            
            // *** VALIDATION: Enforce minimum start number to prevent going backwards ***
            const activeJob = getCurrentJob();
            deriveLastUnitInfo(activeJob); // Re-derive the minimum required start number
            const requiredMinStart = lastUnitInfo.nextStartNum;
            
            if (startNum < requiredMinStart) {
                errorElement.textContent = `The Start # must be at least ${requiredMinStart} to ensure unique, sequential IDs.`;
                errorElement.classList.remove('hidden');
                return;
            }
            // *** END VALIDATION ***

            try {
                const jobDocRef = doc(jobsRef, activeJobId);
                const jobDoc = await getDoc(jobDocRef);

                if (jobDoc.exists()) {
                    const jobData = jobDoc.data();
                    let existingUnits = jobData.units || [];
                    let newUnits = [];

                    const initialHistoryEntry = {
                        action: 'move',
                        stageIndex: 0, 
                        timestamp: Date.now(),
                        movedBy: userId
                    };

                    for (let i = startNum; i <= endNum; i++) {
                        // Use padStart to ensure consistent unit IDs (e.g., UNIT-101)
                        const unitId = prefix + i.toString().padStart(3, '0');
                        if (!existingUnits.some(u => u.unitId === unitId)) {
                            newUnits.push({
                                unitId: unitId,
                                stage: 0,
                                notes: "",
                                history: [initialHistoryEntry]
                            });
                        }
                    }

                    if (newUnits.length === 0) {
                        errorElement.textContent = "All units in that range already exist or the range was invalid.";
                        errorElement.classList.remove('hidden');
                        return;
                    }

                    const updatedUnits = [...existingUnits, ...newUnits];
                    await updateDoc(jobDocRef, { units: updatedUnits });

                    // Auto-advance the suggestion range for next use
                    document.getElementById('unit-start-num').value = endNum + 1;
                    document.getElementById('unit-end-num').value = endNum + 5;
                }
            } catch (error) {
                console.error("Error adding mass units:", error);
                errorElement.textContent = `Database error: ${error.message}`;
                errorElement.classList.remove('hidden');
            }
        };

        // --- FIREBASE: DELETE UNIT CORE (Protected Logic) ---
        const deleteUnitCore = async (unitIdToDelete) => {
            if (!activeJobId || !jobsRef || !userId) {
                console.error("Cannot proceed without active job or user ID.");
                return;
            }
            
            try {
                const jobDocRef = doc(jobsRef, activeJobId);
                const jobDoc = await getDoc(jobDocRef);
                
                if (jobDoc.exists()) {
                    const jobData = jobDoc.data();
                    let units = jobData.units || [];
                    
                    // Filter out the unit to delete
                    const updatedUnits = units.filter(u => u.unitId !== unitIdToDelete);

                    // Check if any unit was actually removed
                    if (updatedUnits.length < units.length) {
                        await updateDoc(jobDocRef, { units: updatedUnits });
                    } else {
                        console.warn(`Unit ID ${unitIdToDelete} not found for deletion.`);
                    }
                }
            } catch (error) {
                console.error("Error deleting unit:", error);
            }
        };


        // Expose functions globally for HTML event handlers
        window.switchJob = switchJob;
        window.switchViewToSummary = switchViewToSummary; 
        window.addJob = addJob;
        window.updateUnitStage = updateUnitStage;
        window.updateUnitStageBackward = updateUnitStageBackward; // Expose new function
        window.handleMassAddUnits = handleMassAddUnits; // The public button handler
        window.showJobModal = showJobModal;
        window.hideJobModal = hideJobModal;
        window.showDeleteModal = showDeleteModal; 
        window.hideDeleteModal = hideDeleteModal;
        window.showUnitDetailModal = showUnitDetailModal;
        window.hideUnitDetailModal = hideUnitDetailModal;
        window.saveUnitNotes = saveUnitNotes;
        window.handleSearchInput = handleSearchInput;
        // Password functions
        window.startProtectedDelete = startProtectedDelete; 
        window.startProtectedDeleteUnit = startProtectedDeleteUnit; // Expose new function
        window.hidePasswordModal = hidePasswordModal;
        window.handlePasswordSubmission = handlePasswordSubmission;


        // Start the application setup
        window.onload = initFirebase;
    </script>
</body>
</html>
